DROP VIEW ITENS_TOTAL;

CREATE VIEW ITENS_TOTAL AS
SELECT ID_VENDA, SUM(QUANTIDADE * PRECO_UNITARIO) AS TOTAL
FROM ITENS_VENDA
GROUP BY ID_VENDA;

CREATE OR REPLACE TRIGGER fretegratis
AFTER INSERT OR UPDATE ON ITENS_VENDA
FOR EACH ROW
DECLARE
    total ITENS_TOTAL.TOTAL%TYPE;
BEGIN  
    SELECT TOTAL INTO total
    FROM ITENS_TOTAL tv
    WHERE tv.ID_VENDA = :NEW.ID_VENDA;
   
    IF(total > 300) THEN
        UPDATE VENDA v
        SET v.FRETE = 0
        WHERE v.ID_VENDA = :NEW.ID_VENDA;
    END IF;    
END;
